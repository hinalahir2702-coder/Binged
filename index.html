<script>
let watched = JSON.parse(localStorage.getItem("watched")) || [];
let wishlist = JSON.parse(localStorage.getItem("wishlist")) || [];
let selectMode = false;
let selectedWatched = new Set();
let selectedWishlist = new Set();

function save() {
  localStorage.setItem("watched", JSON.stringify(watched));
  localStorage.setItem("wishlist", JSON.stringify(wishlist));
}

function toggleSelectMode() {
  selectMode = !selectMode;
  selectedWatched.clear();
  selectedWishlist.clear();
  render();
}

function render() {
  let watchedDiv = document.getElementById("watchedList");
  let wishDiv = document.getElementById("wishlist");

  watchedDiv.innerHTML = "";
  wishDiv.innerHTML = "";

  watched.forEach((e, index) => {
    watchedDiv.innerHTML += `
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          ${selectMode ? `<input type="checkbox" onchange="toggleSelect('watched', ${index})">` : ""}
          <strong>${e.title}</strong>
          ${!selectMode ? `<span style="cursor:pointer;font-size:20px;" onclick="toggleMenu('w${index}')">⋯</span>` : ""}
        </div>

        <div id="w${index}" style="display:none; margin-top:5px;">
          <button onclick="deleteWatched(${index})">Delete</button>
        </div>

        Type: ${e.type}<br>
        Genre: ${e.genre}<br>
        Rating: ${e.rating}/10<br>
        Date: ${e.date}<br>
        Notes: ${e.notes}
      </div>
    `;
  });

  wishlist.forEach((e, index) => {
    wishDiv.innerHTML += `
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          ${selectMode ? `<input type="checkbox" onchange="toggleSelect('wishlist', ${index})">` : ""}
          <strong>${e.title}</strong>
          ${!selectMode ? `<span style="cursor:pointer;font-size:20px;" onclick="toggleMenu('x${index}')">⋯</span>` : ""}
        </div>

        <div id="x${index}" style="display:none; margin-top:5px;">
          <button onclick="deleteWishlist(${index})">Delete</button>
        </div>

        Type: ${e.type}<br>
        Genre: ${e.genre}<br>
        Notes: ${e.notes}
      </div>
    `;
  });
}

function toggleMenu(id) {
  let menu = document.getElementById(id);
  menu.style.display = menu.style.display === "none" ? "block" : "none";
}

function toggleSelect(type, index) {
  if (type === "watched") {
    selectedWatched.has(index)
      ? selectedWatched.delete(index)
      : selectedWatched.add(index);
  } else {
    selectedWishlist.has(index)
      ? selectedWishlist.delete(index)
      : selectedWishlist.add(index);
  }
}

function deleteWatched(index) {
  if (confirm("Delete this item?")) {
    watched.splice(index, 1);
    save();
    render();
  }
}

function deleteWishlist(index) {
  if (confirm("Delete this item?")) {
    wishlist.splice(index, 1);
    save();
    render();
  }
}

function deleteSelected() {
  if (!confirm("Delete selected items?")) return;

  watched = watched.filter((_, i) => !selectedWatched.has(i));
  wishlist = wishlist.filter((_, i) => !selectedWishlist.has(i));

  save();
  toggleSelectMode();
}

function downloadPDF() {
  window.print();
}

render();
</script>
